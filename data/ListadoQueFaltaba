create function [MM].[DestinosAeronavesMenosButacasVendidos]
(@semestre int,
@anio char(4))
returns @table table
(Description varchar(100))
as
begin
declare @desde char(4)
declare @hasta char(4)
if @semestre=1
begin
set @desde='0101'
set @hasta='0530'
end
if @semestre=2
begin
set @desde='0601'
set @hasta='1231'
end
insert into @table  

select top 5 D.Descripcion
from
(select Viaje,count(*) as Cantidad
from MM.Butacas
where Estado='vendida'
group by Viaje)A,
MM.Viajes B,
MM.Rutas_Aereas C,
MM.Ciudades D
where A.Viaje= B.Id and B.Ruta=C.Id and C.Ciudad_Destino=D.Id 
and b.Fecha_salida
between @anio+@desde and @anio+@hasta
group by D.Descripcion
order by sum(A.Cantidad) desc
return
end

GO
